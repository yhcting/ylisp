top="$(CURDIR)"/




TARGET=$(OUTDIR)ylisp
LIBA=lib$(TARGET).a
LIBSO=lib$(TARGET).so
PUB_HEADER=ylisp.h yldef.h ylut.h yllist.h yltrie.h yldynb.h yldev.h ylsfunc.h

INCLUDES=-I../include

UNADIR:=.__unarch/
EXTLIB_DIR:=../lib/
EXTLIB_NAME:=
SYSLIB_DIR:=/usr/lib/
SYSLIB_NAME:=pthread dl
#SYS_LIBRARY=pthread dl
EXTLIB=$(addprefix $(EXTLIB_DIR),$(addsuffix .a,$(addprefix lib,$(EXTLIB_NAME))))
SYSLIB=$(addprefix $(SYSLIB_DIR),$(addsuffix .a,$(addprefix lib,$(SYSLIB_NAME))))

UNALIB=$(EXTLIB) $(SYSLIB)

SOURCES= lisp.c sfunc.c mempool.c parser.c interpret.c nfunc.c gsym.c trie.c ut.c \
	 testmain.c


OBJ=$(subst .c,.o, $(addprefix $(OUTDIR),$(SOURCES)))
DEP_FILES=$(subst .c,.P, $(addprefix $(DEPDIR),$(SOURCES)))

CFLAGS+= -g -Wall
# temp block... no lib to link
LDFLAGS+= -rdynamic -ldl -lrt -lpthread
SOFLAGS+=

# Target name of dependency file generated by GCC, is just xxx.o
# So, we need post processing to handle it properly.
# To avoid this overhead... we don't use output directory.!
OUTDIR=
CC=gcc
C_COMPILE=$(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS)
C_DEPENDENCIES=-Wp,-MD,$(DEPDIR)$(*F).P
C_LINK=$(CC) $(CFLAGS) $(LDFLAGS) -L.
SO_LINK=$(CC) $(SOFLAGS)
AR=ar
AR_CMD=$(AR) cr

VERSION=1.0

DISTDIR=$(top)$(shell basename $(top))-$(VERSION)
DEPDIR=.deps/



debug: $(TARGET)

release: $(LIBA) $(LIBSO)
	cp $(PUB_HEADER) ../include

DEPS_MAGIC := $(shell mkdir $(DEPDIR) $(OUTDIR) > /dev/null 2>&1 || :)

# simply ignore file which doesn't exist. (At first these files don't exist..)
-include $(DEP_FILES)

# Interesting!!! : following two are different! And those don't work correctly!!
#	$(foreach lib, $(UNALIB), $(shell cd $(UNADIR); $(AR) x $(lib)))
#	$(foreach lib, $(UNALIB), cd $(UNADIR); $(AR) x $(lib))

#UNACMD=$(addprefix $(AR) x , $(addsuffix ;, $(UNALIB)))
#$(UNADIR): $(UNALIB)
#	mkdir $(UNADIR)
#	cd $(UNADIR); $(UNACMD)

$(OUTDIR)%.o: %.c
	@echo '$(C_COMPILE) -o $@ -c $<'; \
	$(C_COMPILE) $(C_DEPENDENCIES) -o $@ -c $<

#$(LIB): $(OBJ) $(UNADIR)
#	@echo '$(AR_CMD) $@ $(OBJ) $(wildcard $(UNADIR)*.o)'; \
#	$(AR_CMD) $@ $(OBJ) $(wildcard $(UNADIR)*.o)
#	cp $@ ../lib/
#	cp $(PUB_HEADER) ../include

$(LIBA): $(OBJ)
	@echo '$(AR_CMD) $@ $^'; \
	$(AR_CMD) $@ $^
	cp $@ ../lib/

# Is 'chmod' really only way to change mode of output so file?? Any elegant way????
$(LIBSO): $(OBJ)
	@echo '$(SO_LINK) $@ $^'; \
	$(SO_LINK) -shared -Wl,-soname,$@ -o $@ $^
	chmod 0644 $@
	cp $@ ../lib/

$(TARGET): $(OBJ) $(EXTLIB)
	@echo '$(C_LINK) -o $@ $^'; \
	$(C_LINK) -o  $@ $^


tags:


clean:
	rm -f *.mod *.o *.obj .lo $(TARGET) $(LIBA) $(LIBSO)
	rm -rf $(DEPDIR)
	rm -rf $(OUTDIR)
	rm -rf $(UNADIR)

.PHONY: dist

dist:
	rm -rf $(DISTDIR)
	mkdir $(DISTDIR)
	cp $(SOURCES) $(DISTDIR)
	tar -cvzf $(DISTDIR).tar.gz $(DISTDIR)
	rm -rf $(DISTDIR)

# End of Makefile
